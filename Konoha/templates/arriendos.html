<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arriendos</title>

  <!-- Tailwind CSS via CDN (para prototipo). En producción compila Tailwind. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Pequeños estilos extra */
    .currency { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">Arriendos</h1>
      <p class="text-sm text-gray-600">Selecciona equipo, define periodo y confirma tu reserva.</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Catálogo -->
      <section class="col-span-2">
        <h2 class="text-lg font-semibold mb-4">Catálogo</h2>
        <div id="catalog" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>

      <!-- Resumen -->
      <aside class="col-span-1">
        <div class="sticky top-6 border rounded-lg p-4 bg-white shadow-sm">
          <h2 class="text-lg font-semibold">Resumen de arriendo</h2>

          <div id="cart-empty" class="mt-3 text-sm text-gray-500">No hay productos en el carrito.</div>

          <ul id="cart-list" class="mt-3 space-y-3"></ul>

          <div id="summary" class="mt-4 border-t pt-3 text-sm hidden">
            <div class="flex justify-between"><span>Subtotal</span><span id="subtotal" class="currency"></span></div>
            <div class="flex justify-between"><span>Depósito</span><span id="deposit" class="currency"></span></div>
            <div class="flex justify-between font-medium mt-2"><span>TOTAL</span><span id="total" class="currency"></span></div>

            <button id="checkout-btn" class="mt-4 w-full bg-green-600 text-white py-2 rounded-md font-semibold">
              Proceder al pago
            </button>

            <div class="mt-3 text-xs text-gray-500">
              Nota: los depósitos se retienen y se reembolsan tras la devolución si no hay daños.
            </div>
          </div>
        </div>
      </aside>
    </main>

    <footer class="mt-8 text-sm text-gray-600">
      <strong>Ideas de integración:</strong>
      <ul class="list-disc list-inside">
        <li>Verificar disponibilidad real desde el backend antes de confirmar.</li>
        <li>Integrar pasarela de pagos (Stripe, PayPal) y crear órdenes en el servidor.</li>
        <li>Agregar seguros opcionales, condiciones de devolución y calendarios bloqueados.</li>
      </ul>
    </footer>
  </div>

  <!-- Scripts -->
  <script>
    // --------- Datos de ejemplo (sustituir por fetch a tu API) ----------
    const PRODUCTS = [
      { id: 1, title: "Cámara Mirrorless Sony A7", pricePerDay: 25.0, deposit: 150.0, available: true },
      { id: 2, title: "Lente 24-70mm f/2.8", pricePerDay: 12.0, deposit: 80.0, available: true },
      { id: 3, title: "Gimbal estabilizador", pricePerDay: 8.0, deposit: 60.0, available: false },
      { id: 4, title: "Set Iluminación LED", pricePerDay: 10.0, deposit: 50.0, available: true }
    ];

    // Carrito en memoria: array de { cartId, productId, qty, startDate, endDate }
    let cart = [];

    // Formateador de moneda (MXN, cambiar si necesitas otra)
    const money = x => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(x);

    // ---------- Render catálogo ----------
    const catalogEl = document.getElementById('catalog');

    function renderCatalog() {
      catalogEl.innerHTML = '';
      for (const p of PRODUCTS) {
        const card = document.createElement('article');
        card.className = 'border rounded-lg p-4 bg-white shadow-sm flex gap-4 items-start';
        card.innerHTML = `
          <div class="w-24 h-24 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">
            <span class="text-xs">Imagen</span>
          </div>
          <div class="flex-1">
            <h3 class="font-medium">${p.title}</h3>
            <div class="text-sm text-gray-600">${money(p.pricePerDay)} / día</div>
            <div class="text-sm text-gray-500">Depósito: ${money(p.deposit)}</div>
            <div class="mt-3 flex gap-2">
              <button class="add-btn px-3 py-1 rounded-md text-sm font-medium ${p.available ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}" data-id="${p.id}" ${p.available ? '' : 'disabled'}>
                Añadir
              </button>
              <button class="detail-btn px-3 py-1 rounded-md text-sm border" data-id="${p.id}">
                Detalles
              </button>
            </div>
          </div>
        `;
        catalogEl.appendChild(card);
      }
      // Event listeners para botones Añadir
      document.querySelectorAll('.add-btn').forEach(b => {
        b.addEventListener('click', e => {
          const id = Number(e.currentTarget.dataset.id);
          addToCart(id);
        });
      });
      document.querySelectorAll('.detail-btn').forEach(b => {
        b.addEventListener('click', e => {
          const id = Number(e.currentTarget.dataset.id);
          const p = PRODUCTS.find(x => x.id === id);
          alert(`${p.title}\nPrecio por día: ${money(p.pricePerDay)}\nDepósito: ${money(p.deposit)}\nDisponibilidad: ${p.available ? 'Disponible' : 'No disponible'}`);
        });
      });
    }

    // ---------- Helper fechas ----------
    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }
    function addDaysISO(dateISO, days) {
      const d = new Date(dateISO);
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }

    // Calcula días inclusivos (si inicio = fin => 1 día)
    function daysBetween(startIso, endIso) {
      if (!startIso || !endIso) return 0;
      const s = new Date(startIso);
      const e = new Date(endIso);
      // diferencia en ms
      const diffMs = e - s;
      const days = Math.floor(diffMs / (1000*60*60*24)) + 1; // inclusive
      return days > 0 ? days : 0;
    }

    // ---------- Carrito: añadir ----------
    function addToCart(productId) {
      const product = PRODUCTS.find(p => p.id === productId);
      if (!product || !product.available) {
        alert('Producto no disponible.');
        return;
      }
      const start = todayISO();
      const end = addDaysISO(start, 1); // por defecto 2 días? aquí 1 día extra -> 2? we set +1 => next day, inclusive => 2 days. To default 1 day rental, set end = start
      // I'll set default end = same day => 1 day rental
      const defaultEnd = start; // 1 día
      const cartItem = {
        cartId: Math.random().toString(36).slice(2,9),
        productId,
        qty: 1,
        startDate: start,
        endDate: defaultEnd
      };
      cart.push(cartItem);
      renderCart();
    }

    // ---------- Render carrito ----------
    const cartListEl = document.getElementById('cart-list');
    const cartEmptyEl = document.getElementById('cart-empty');
    const summaryEl = document.getElementById('summary');
    const subtotalEl = document.getElementById('subtotal');
    const depositEl = document.getElementById('deposit');
    const totalEl = document.getElementById('total');
    const checkoutBtn = document.getElementById('checkout-btn');

    function renderCart() {
      cartListEl.innerHTML = '';
      if (cart.length === 0) {
        cartEmptyEl.style.display = 'block';
        summaryEl.classList.add('hidden');
        return;
      }
      cartEmptyEl.style.display = 'none';
      summaryEl.classList.remove('hidden');

      for (const item of cart) {
        const p = PRODUCTS.find(x => x.id === item.productId);
        const days = daysBetween(item.startDate, item.endDate) || 1;
        const subtotal = p.pricePerDay * item.qty * days;
        const deposit = p.deposit * item.qty;
        const total = subtotal + deposit;

        const li = document.createElement('li');
        li.className = 'border rounded p-3 bg-white';
        li.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-medium text-sm">${p.title}</div>
              <div class="text-xs text-gray-500">${money(p.pricePerDay)} / día</div>
            </div>
            <div class="text-right text-sm">
              <div class="font-medium">${money(total)}</div>
              <button class="text-xs text-red-500 mt-2 remove-btn" data-cartid="${item.cartId}">Remover</button>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
            <div>
              <label class="block">Desde</label>
              <input type="date" class="start-date mt-1 w-full text-sm border rounded px-2 py-1" value="${item.startDate}" min="${todayISO()}" data-cartid="${item.cartId}">
            </div>
            <div>
              <label class="block">Hasta</label>
              <input type="date" class="end-date mt-1 w-full text-sm border rounded px-2 py-1" value="${item.endDate}" min="${item.startDate}" data-cartid="${item.cartId}">
            </div>
          </div>

          <div class="mt-2 text-xs text-gray-600 flex items-center gap-2">
            <div>Días: <span class="font-medium days-count ml-1">${days}</span></div>
            <div class="ml-3">Cantidad:
              <input type="number" min="1" class="qty-input ml-2 w-16 p-1 border rounded text-sm" value="${item.qty}" data-cartid="${item.cartId}">
            </div>
          </div>

          <div class="mt-2 text-sm">
            <div>Subtotal: <span class="currency">${money(subtotal)}</span></div>
            <div>Depósito: <span class="currency">${money(deposit)}</span></div>
          </div>
        `;
        cartListEl.appendChild(li);
      }

      // asignar listeners dentro del render
      document.querySelectorAll('.remove-btn').forEach(b => {
        b.addEventListener('click', e => {
          const cid = e.currentTarget.dataset.cartid;
          removeFromCart(cid);
        });
      });
      document.querySelectorAll('.start-date').forEach(inp => {
        inp.addEventListener('change', e => {
          const cid = e.currentTarget.dataset.cartid;
          const value = e.currentTarget.value;
          updateCartItem(cid, { startDate: value });
        });
      });
      document.querySelectorAll('.end-date').forEach(inp => {
        inp.addEventListener('change', e => {
          const cid = e.currentTarget.dataset.cartid;
          const value = e.currentTarget.value;
          updateCartItem(cid, { endDate: value });
        });
      });
      document.querySelectorAll('.qty-input').forEach(inp => {
        inp.addEventListener('change', e => {
          const cid = e.currentTarget.dataset.cartid;
          const value = Math.max(1, Number(e.currentTarget.value) || 1);
          updateCartItem(cid, { qty: value });
        });
      });

      updateSummary();
    }

    // ---------- Actualizar carrito ----------
    function updateCartItem(cartId, patch) {
      cart = cart.map(c => c.cartId === cartId ? { ...c, ...patch } : c);
      // Asegurar que endDate >= startDate
      cart = cart.map(c => {
        if (new Date(c.endDate) < new Date(c.startDate)) {
          c.endDate = c.startDate;
        }
        return c;
      });
      renderCart();
    }

    function removeFromCart(cartId) {
      cart = cart.filter(c => c.cartId !== cartId);
      renderCart();
    }

    // ---------- Resumen calculos ----------
    function updateSummary() {
      let subtotal = 0;
      let deposit = 0;
      for (const item of cart) {
        const p = PRODUCTS.find(x => x.id === item.productId);
        const days = daysBetween(item.startDate, item.endDate) || 1;
        subtotal += p.pricePerDay * item.qty * days;
        deposit += p.deposit * item.qty;
      }
      const total = subtotal + deposit;
      subtotalEl.textContent = money(subtotal);
      depositEl.textContent = money(deposit);
      totalEl.textContent = money(total);
    }

    // ---------- Checkout ----------
    checkoutBtn.addEventListener('click', () => {
      if (cart.length === 0) { alert('El carrito está vacío.'); return; }
      // Validaciones de fechas
      for (const item of cart) {
        if (daysBetween(item.startDate, item.endDate) <= 0) {
          alert('Revisa las fechas: la fecha final debe ser igual o posterior a la inicial.');
          return;
        }
      }
      // Aquí harías un POST al backend para crear la orden/reserva y redirigir a pago.
      // Demo: mostrar resumen
      let msg = 'Resumen de la orden:\\n';
      for (const item of cart) {
        const p = PRODUCTS.find(x => x.id === item.productId);
        const days = daysBetween(item.startDate, item.endDate) || 1;
        msg += `- ${p.title} x${item.qty} · ${days} día(s) · ${money(p.pricePerDay * item.qty * days)}\\n`;
      }
      let total = document.getElementById('total').textContent;
      msg += `TOTAL: ${total}\\n\\n(En integración real, crearía la orden y redirigiría a la pasarela.)`;
      alert(msg);

      // Simular limpieza
      cart = [];
      renderCart();
    });

    // Inicializar
    renderCatalog();
    renderCart();
  </script>
</body>
</html>
